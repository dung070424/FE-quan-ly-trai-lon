<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Qu·∫£n l√Ω kho thu·ªëc</h1>
    </div>

    <!-- Dashboard Stats -->
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-value">{{ totalMedicinesCount }}</div>
            <div class="stat-label">T·ªïng s·ªë thu·ªëc</div>
        </div>
        <div class="stat-card orange">
            <div class="stat-value">{{ almostOutOfStockCount }}</div>
            <div class="stat-label">S·∫Øp h·∫øt h√†ng</div>
        </div>
        <div class="stat-card red">
            <div class="stat-value">{{ almostExpiredCount }}</div>
            <div class="stat-label">S·∫Øp h·∫øt h·∫°n</div>
        </div>
        <div class="stat-card dark-red">
            <div class="stat-value">{{ expiredCount }}</div>
            <div class="stat-label">ƒê√£ h·∫øt h·∫°n</div>
        </div>
        <div class="stat-card green bg-soft-green">
            <div class="stat-value text-green">{{ formatCurrency(totalValue) }}</div>
            <div class="stat-label">T·ªïng gi√° tr·ªã</div>
        </div>
    </div>

    <div class="view-toolbar">
        <h2 class="section-title">Danh s√°ch thu·ªëc trong kho</h2>

        <div class="search-box">
            <input type="text" placeholder="T√¨m ki·∫øm t√™n, lo·∫°i..." [(ngModel)]="searchTerm" class="search-input" />
        </div>

        <div class="action-buttons">
            <button class="btn btn-warning" (click)="openImportModal()">
                <span>+</span> Nh·∫≠p kho
            </button>
            <button class="btn btn-danger" (click)="openHistoryModal()">
                <span>üìã</span> L·ªãch s·ª≠ nh·∫≠p
            </button>
            <button class="btn btn-success" (click)="loadInventories()">
                <span>‚Ü∫</span> L√†m m·ªõi
            </button>
        </div>
    </div>

    <!-- Inventory Grid -->
    <div class="inventory-grid">
        @for (inv of filteredInventories; track inv.id) {
        <div class="inventory-card">
            <div class="card-header">
                <h3 class="medicine-name">{{ inv.medicineName }}</h3>
                <div class="badges">
                    <span class="badge status-normal" *ngIf="inv.quantity > (inv.minQuantity || 0)">B√¨nh th∆∞·ªùng</span>
                    <span class="badge status-warning" *ngIf="inv.quantity <= (inv.minQuantity || 0)">S·∫Øp h·∫øt
                        h√†ng</span>

                    <span class="badge status-expired" *ngIf="getExpiryStatus(inv.expiryDate) === 'expired'">H·∫øt
                        h·∫°n</span>
                    <span class="badge status-warning" *ngIf="getExpiryStatus(inv.expiryDate) === 'almost'">S·∫Øp h·∫øt
                        h·∫°n</span>
                </div>
            </div>

            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Lo·∫°i:</span>
                    <span class="info-value font-medium">{{ inv.type }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">S·ªë l∆∞·ª£ng:</span>
                    <span class="info-value text-blue fw-bold">{{ inv.quantity }} {{ inv.unit }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">T·ªëi thi·ªÉu:</span>
                    <span class="info-value">{{ inv.minQuantity }} {{ inv.unit }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">T·ªëi ƒëa:</span>
                    <span class="info-value">{{ inv.maxQuantity }} {{ inv.unit }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Gi√° tr·ªã:</span>
                    <span class="info-value text-green fw-bold">{{ formatCurrency((inv.unitPrice || 0) * inv.quantity)
                        }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">H·∫øt h·∫°n:</span>
                    <span class="info-value">{{ inv.expiryDate | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">V·ªã tr√≠:</span>
                    <span class="info-value">{{ inv.location }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">C·∫≠p nh·∫≠t:</span>
                    <span class="info-value">{{ inv.lastUpdated | date:'dd/MM/yyyy' }}</span>
                </div>
            </div>

            <div class="card-footer">
                <div class="progress-bar-container">
                    <div class="progress-bar" [style.width.%]="getProgressPercentage(inv.quantity, inv.maxQuantity)"
                        [class.bg-green]="getProgressPercentage(inv.quantity, inv.maxQuantity) > 20"
                        [class.bg-red]="getProgressPercentage(inv.quantity, inv.maxQuantity) <= 20">
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-danger" (click)="openExportModal(inv)">Xu·∫•t kho</button>
                </div>
            </div>
        </div>
        } @empty {
        <div class="empty-state">Kh√¥ng c√≥ thu·ªëc n√†o trong kho.</div>
        }
    </div>
</div>

<!-- Import Modal -->
<div class="modal-overlay" *ngIf="isImportModalOpen">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Nh·∫≠p kho thu·ªëc</h2>
            <button class="close-btn" (click)="closeImportModal()">√ó</button>
        </div>
        <div class="modal-body">
            <form [formGroup]="importForm" (ngSubmit)="saveImport()">
                <div class="form-group">
                    <label>T√™n Thu·ªëc (L·∫•y t·ª´ Danh m·ª•c) <span class="required">*</span></label>
                    <select formControlName="medicineId" class="form-control"
                        [class.is-invalid]="importForm.get('medicineId')?.invalid && importForm.get('medicineId')?.touched">
                        <option value="">-- Ch·ªçn thu·ªëc --</option>
                        <option *ngFor="let m of medicines" [value]="m.id">{{ m.name }} ({{ m.medicineCode }})</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i <span class="required">*</span></label>
                        <input type="text" formControlName="type" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>S·ªë l∆∞·ª£ng Nh·∫≠p <span class="required">*</span></label>
                        <input type="number" formControlName="quantity" class="form-control" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>ƒê∆°n v·ªã t√≠nh <span class="required">*</span></label>
                        <input type="text" formControlName="unit" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>ƒê∆°n gi√° / ƒë∆°n v·ªã <span class="required">*</span></label>
                        <input type="number" formControlName="unitPrice" class="form-control" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Min Qty <span class="required">*</span></label>
                        <input type="number" formControlName="minQuantity" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Max Qty <span class="required">*</span></label>
                        <input type="number" formControlName="maxQuantity" class="form-control" />
                    </div>
                </div>

                <div class="form-group">
                    <label>V·ªã tr√≠ trong kho <span class="required">*</span></label>
                    <input type="text" formControlName="location" class="form-control" placeholder="K·ªá A1..." />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeImportModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-warning" [disabled]="importForm.invalid">Nh·∫≠p Kho</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal-overlay" *ngIf="isExportModalOpen">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Xu·∫•t kho: {{ currentExportInventory?.medicineName }}</h2>
            <button class="close-btn" (click)="closeExportModal()">√ó</button>
        </div>
        <div class="modal-body">
            <p>Trong kho hi·ªán c√≤n <strong>{{ currentExportInventory?.quantity }}</strong> {{
                currentExportInventory?.unit }}</p>
            <form [formGroup]="exportForm" (ngSubmit)="saveExport()">
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng xu·∫•t <span class="required">*</span></label>
                    <input type="number" formControlName="amount" class="form-control"
                        [class.is-invalid]="exportForm.get('amount')?.invalid && exportForm.get('amount')?.touched" />
                    <div *ngIf="exportForm.get('amount')?.hasError('max')" class="invalid-feedback">
                        Kh√¥ng th·ªÉ xu·∫•t l·ªõn h∆°n T·ªìn kho.
                    </div>
                    <div *ngIf="exportForm.get('amount')?.hasError('min')" class="invalid-feedback">
                        Ph·∫£i xu·∫•t √≠t nh·∫•t 1.
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeExportModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-danger" [disabled]="exportForm.invalid">Xu·∫•t Kho</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal-overlay" *ngIf="isHistoryModalOpen">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>L·ªãch s·ª≠ nh·∫≠p thu·ªëc</h2>
            <button class="close-btn" (click)="closeHistoryModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>T√™n thu·ªëc</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let h of importHistory">
                            <td>{{ h.importDate | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td>{{ h.medicineName }}</td>
                            <td class="text-blue fw-bold">{{ h.quantity }} {{ h.unit }}</td>
                            <td>{{ formatCurrency(h.unitPrice || 0) }}</td>
                            <td class="text-green fw-bold">{{ formatCurrency(h.totalPrice || 0) }}</td>
                        </tr>
                        <tr *ngIf="importHistory.length === 0">
                            <td colspan="5" class="empty-message">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ nh·∫≠p kho.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card-footer" style="background: transparent; justify-content: flex-end; padding-top: 16px;">
                <div class="total-summary" style="display: flex; gap: 12px; align-items: baseline;">
                    <span class="total-label">T·ªïng ti·ªÅn c√°c l·∫ßn nh·∫≠p:</span>
                    <span class="total-value text-green" style="font-size: 1.5rem;">{{ formatCurrency(totalImportCost)
                        }}</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeHistoryModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>